generator client {
  // Antes: provider = "prisma-client-js"
  provider = "prisma-client"
  // Podés dejar el output como lo tenías, generando dentro de app:
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
  // ⚠️ IMPORTANTE: en Prisma 7 ya NO se pone la URL acá.
  // La DATABASE_URL se configura en prisma.config.ts
}


// -- CLIENTE -- //
model Cliente {
  id        Int     @id @default(autoincrement())

  nombre    String?
  apellido  String?
  ubicacion String?
  telefono  String?
  email     String?
  pedidos   Pedido[]
}

// ---------- PEDIDOS ----------

model Pedido {
  id        Int              @id @default(autoincrement())
  numero    Int              @unique      // ej: 40
  clienteId Int
  cliente   Cliente          @relation(fields: [clienteId], references: [id])
  contacto  String?

  productos PedidoProducto[]
  lotes     Lote[]           @relation("PedidoLotes")
  registrosManuales RegistroManual[]

  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
}

model PedidoProducto {
  id         Int      @id @default(autoincrement())
  pedidoId   Int
  productoId Int
  cantidad   Int

  pedido   Pedido   @relation(fields: [pedidoId], references: [id])
  producto Producto @relation(fields: [productoId], references: [id])
}

model Producto {
  id          Int               @id @default(autoincrement())
  nombre      String
  codigo      String            @unique
  tieneTalles Boolean           @default(false)

  lotes       Lote[]            @relation("ProductoLotes")
  pedidos     PedidoProducto[]
  plantillaPasos PlantillaPaso[]

  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
}

model PlantillaPaso {
  id                   Int      @id @default(autoincrement())
  productoId           Int
  nombre               String
  orden                Int
  duracionEstimadaDias Float?
  precio               Float?
  requiereAdelanto     Boolean  @default(false)
  especificaciones     String?
  tallerPorDefectoId   Int?
  esTransporte         Boolean  @default(false)

  producto             Producto @relation(fields: [productoId], references: [id])
  tallerPorDefecto     Taller?  @relation("PlantillaPasoTallerPorDefecto", fields: [tallerPorDefectoId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productoId, orden])
  @@unique([productoId, nombre])
}


// ---------- LOTES & ESTADOS ----------

enum LoteEstado {
  ACTIVO
  DIVIDIDO
  TERMINADO
}

enum EstadoProceso {
  PENDIENTE
  EN_PROCESO
  COMPLETADO
  NO_ENVIADO
}

model Lote {
  id                     Int       @id @default(autoincrement())
  codigo                 String    @unique   // ej: "40.1", "40.3"
  pedidoId               Int
  parentId               Int?
  cantidad               Int
  estado                 LoteEstado @default(ACTIVO)

  // Progreso y tiempos del lote
  porcentajeCompletado       Float    @default(0)
  fechaIngresoProcesoActual  DateTime?
  fechaEstimadaFinalizacion  DateTime?
  tiempoRestanteDias         Float    @default(0)

  // FKs para ubicación actual
  procesoActualId        Int?
  tallerActualId         Int?
  transportistaActualId  Int?

  // producto asociado a este lote
  productoId             Int?
  producto               Producto?  @relation("ProductoLotes", fields: [productoId], references: [id])

  // Relaciones
  pedido        Pedido   @relation("PedidoLotes", fields: [pedidoId], references: [id])
  parent        Lote?    @relation("SubLotes", fields: [parentId], references: [id])
  children      Lote[]   @relation("SubLotes")

  procesoActual      Proceso?      @relation("LoteProcesoActual", fields: [procesoActualId], references: [id])
  tallerActual       Taller?       @relation("LoteTallerActual", fields: [tallerActualId], references: [id])
  transportistaActual Transportista? @relation("LoteTransportistaActual", fields: [transportistaActualId], references: [id])

  procesosHistorial ProcesoRealizado[] @relation("LoteProcesoRealizado")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


// ---------- PROCESOS / TALLERES / TRANSPORTISTAS ----------

model Proceso {
  id     Int      @id @default(autoincrement())
  nombre String   @unique  // "Corte", "Costura", "Bordado", etc.

  duracionEstandarDias Int  @default(1)
  orden                Int

  lotesProcesoActual Lote[]              @relation("LoteProcesoActual")
  procesosHistorial  ProcesoRealizado[]  @relation("ProcesoRealizadoProceso")
}

model Taller {
  id        Int      @id @default(autoincrement())
  nombre    String
  tipo      String
  direccion String?
  telefono  String?
  activo    Boolean  @default(true)

  lotesActuales    Lote[]              @relation("LoteTallerActual")
  procesosHistorial ProcesoRealizado[] @relation("ProcesoRealizadoTaller")
  plantillasPorDefecto PlantillaPaso[] @relation("PlantillaPasoTallerPorDefecto")
  registrosManuales RegistroManual[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Transportista {
  id        Int      @id @default(autoincrement())
  nombre    String
  telefono  String?
  activo    Boolean  @default(true)

  lotesActuales     Lote[]              @relation("LoteTransportistaActual")
  procesosHistorial ProcesoRealizado[]  @relation("ProcesoRealizadoTransportista")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


// ---------- HISTORIAL (MOVIMIENTOS) ----------

model ProcesoRealizado {
  id              Int      @id @default(autoincrement())
  loteId          Int
  procesoId       Int?
  tallerId        Int?
  transportistaId Int?

  estado          EstadoProceso @default(PENDIENTE)
  fechaEntrada    DateTime?
  fechaSalida     DateTime?
  notas           String?
  precio               Float?
  requiereAdelanto     Boolean  @default(false)
  especificaciones     String?
  esTransporte         Boolean  @default(false)

  lote          Lote          @relation("LoteProcesoRealizado", fields: [loteId], references: [id])
  proceso       Proceso?      @relation("ProcesoRealizadoProceso", fields: [procesoId], references: [id])
  taller        Taller?       @relation("ProcesoRealizadoTaller", fields: [tallerId], references: [id])
  transportista Transportista? @relation("ProcesoRealizadoTransportista", fields: [transportistaId], references: [id])
}

// ---------- REGISTROS MANUALES ----------

enum TipoRegistroManual {
  PAGO
  RECORDATORIO
  NOTA_GENERAL
}

model RegistroManual {
  id          Int      @id @default(autoincrement())
  tipo        TipoRegistroManual
  descripcion String
  monto       Float?
  fecha       DateTime @default(now())
  usuario     String?
  pedidoId    Int?
  tallerId    Int?

  pedido Pedido? @relation(fields: [pedidoId], references: [id])
  taller Taller? @relation(fields: [tallerId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
